<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Payment â€¢ Reading Group</title>
	<link rel="stylesheet" href="./styles.css">
</head>
<body>
	<header class="nav">
		<h1>Payment</h1>
		<nav>
			<a href="./dashboard.html">Dashboard</a>
		</nav>
	</header>
	<main class="container card">
		<div class="payment-info">
			<h2>ğŸ’° Unlock Reading Sessions</h2>
			<div class="price">â‚¦500</div>
			<p>One-time payment to unlock unlimited reading sessions and earn points!</p>
			
			<div class="features">
				<div class="feature">âœ… Unlimited reading sessions</div>
				<div class="feature">âœ… Earn points for each session</div>
				<div class="feature">âœ… Join the leaderboard</div>
				<div class="feature">âœ… Track your reading progress</div>
			</div>
		</div>
		
		<div class="payment-form">
			<input id="email" placeholder="Your email" type="email" />
			<button id="pay-btn" class="pay-button">Pay â‚¦500 Now</button>
			<div id="payment-status" style="display: none;"></div>
		</div>
		
		<div class="payment-methods">
			<p><strong>Payment Methods:</strong></p>
			<p>ğŸ’³ Card, ğŸ¦ Bank Transfer, ğŸ“± Mobile Money</p>
			<p><small>Powered by Paystack</small></p>
		</div>
	</main>

	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
	<script src="../firebase-config.js"></script>
	<script>
	(function(){
		const app = firebase.initializeApp(window.firebaseConfig);
		const auth = firebase.auth();
		const db = firebase.firestore();
		
		// Check if user is logged in
		auth.onAuthStateChanged((user) => {
			if (!user) {
				alert('Please login first');
				location.href = './login.html';
				return;
			}
			
			// Check if user already paid
			checkPaymentStatus(user.uid);
			
			// Set email field
			const emailField = document.getElementById('email');
			emailField.value = user.email;
		});
		
		async function checkPaymentStatus(userId) {
			try {
				const userDoc = await db.collection('users').doc(userId).get();
				if (userDoc.exists() && userDoc.data().paymentStatus) {
					showPaymentStatus('You have already paid! Redirecting to dashboard...', 'success');
					setTimeout(() => {
						location.href = './dashboard.html';
					}, 2000);
				}
			} catch (error) {
				console.error('Error checking payment status:', error);
			}
		}
		
		document.getElementById('pay-btn').onclick = async () => {
			const user = auth.currentUser;
			if (!user) {
				alert('Please login first');
				return;
			}
			
			try {
				const payBtn = document.getElementById('pay-btn');
				payBtn.disabled = true;
				payBtn.textContent = 'Processing...';
				
				// Create payment record
				const paymentRef = await db.collection('payments').add({
					userId: user.uid,
					email: user.email,
					amount: 500,
					currency: 'NGN',
					status: 'pending',
					createdAt: firebase.firestore.FieldValue.serverTimestamp()
				});
				
				// For demo purposes, simulate successful payment
				// In real implementation, integrate with Paystack here
				
				// Simulate payment success after 2 seconds
				setTimeout(async () => {
					try {
						// Update payment status
						await paymentRef.update({
							status: 'success',
							completedAt: firebase.firestore.FieldValue.serverTimestamp()
						});
						
						// Update user payment status
						await db.collection('users').doc(user.uid).update({
							paymentStatus: true,
							paymentDate: firebase.firestore.FieldValue.serverTimestamp()
						});
						
						showPaymentStatus('Payment successful! Redirecting to dashboard...', 'success');
						setTimeout(() => {
							location.href = './dashboard.html';
						}, 2000);
						
					} catch (error) {
						console.error('Error updating payment:', error);
						showPaymentStatus('Payment failed. Please try again.', 'error');
						payBtn.disabled = false;
						payBtn.textContent = 'Pay â‚¦500 Now';
					}
				}, 2000);
				
				showPaymentStatus('Processing payment...', 'info');
				
			} catch (error) {
				console.error('Payment error:', error);
				showPaymentStatus('Payment failed: ' + error.message, 'error');
				document.getElementById('pay-btn').disabled = false;
				document.getElementById('pay-btn').textContent = 'Pay â‚¦500 Now';
			}
		};
		
		function showPaymentStatus(message, type) {
			const statusEl = document.getElementById('payment-status');
			statusEl.textContent = message;
			statusEl.className = type;
			statusEl.style.display = 'block';
		}
	})();
	</script>
</body>
</html>

