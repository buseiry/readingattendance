<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Payment â€¢ Reading Group</title>
	<link rel="stylesheet" href="./styles.css">
</head>
<body>
	<header class="nav">
		<h1>Payment</h1>
		<nav>
			<a href="./dashboard.html">Dashboard</a>
		</nav>
	</header>
	<main class="container card">
		<div class="payment-info">
			<h2>ğŸ’° Unlock Reading Sessions</h2>
			<div class="price">â‚¦500</div>
			<p>One-time payment to unlock unlimited reading sessions and earn points!</p>
			
			<div class="features">
				<div class="feature">âœ… Unlimited reading sessions</div>
				<div class="feature">âœ… Earn points for each session</div>
				<div class="feature">âœ… Join the leaderboard</div>
				<div class="feature">âœ… Track your reading progress</div>
			</div>
		</div>
		
		<div class="payment-form">
			<input id="email" placeholder="Your email" type="email" />
			<button id="pay-btn" class="pay-button">Pay â‚¦500 Now</button>
			<div id="payment-status" style="display: none;"></div>
		</div>
		
		<div class="payment-methods">
			<p><strong>Payment Methods:</strong></p>
			<p>ğŸ’³ Card, ğŸ¦ Bank Transfer, ğŸ“± Mobile Money</p>
			<p><small>Powered by Paystack</small></p>
		</div>
	</main>

	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script src="./firebase-config.js"></script>
	<script>
	(function(){
		const app = firebase.initializeApp(window.firebaseConfig);
		const auth = firebase.auth();
		const db = firebase.firestore();
		
		// Check if user is logged in
		auth.onAuthStateChanged((user) => {
			if (!user) {
				alert('Please login first');
				location.href = './login.html';
				return;
			}
			
			// Check if user already paid
			checkPaymentStatus(user.uid);
			
			// Set email field
			const emailField = document.getElementById('email');
			emailField.value = user.email;
		});
		
		async function checkPaymentStatus(userId) {
			try {
				const userDoc = await db.collection('users').doc(userId).get();
				if (userDoc.exists() && userDoc.data().paymentStatus) {
					showPaymentStatus('You have already paid! Redirecting to dashboard...', 'success');
					setTimeout(() => {
						location.href = './dashboard.html';
					}, 2000);
				}
			} catch (error) {
				console.error('Error checking payment status:', error);
			}
		}
		
        document.getElementById('pay-btn').onclick = async () => {
			const user = auth.currentUser;
			if (!user) {
				alert('Please login first');
				return;
			}
			
			try {
				const payBtn = document.getElementById('pay-btn');
				payBtn.disabled = true;
				payBtn.textContent = 'Processing...';
				
            // Use callable functions for backend-managed payment flow
            const functionsApp = firebase.app();
            const functionsRegion = firebase.app().options?.messagingSenderId ? undefined : undefined; // placeholder; compat auto-uses default region
            const functions = firebase.functions();

            const createPayment = functions.httpsCallable('createPayment');
            const verifyPayment = functions.httpsCallable('verifyPayment');

            // 1) Create payment on server to obtain reference
            showPaymentStatus('Creating payment...', 'info');
            let createRes;
            try {
              createRes = await createPayment({ email: user.email, amount: 500 });
            } catch (e) {
              console.error('createPayment failed', e);
              throw new Error('Failed to create payment. Check server logs for details.');
            }

            const reference = createRes?.data?.reference;
            if (!reference) {
              console.error('createPayment missing reference', createRes);
              throw new Error('Payment reference not returned by server');
            }

            // 2) Launch Paystack Inline
            const PAYSTACK_PUBLIC_KEY = 'pk_test_XXXXXXXXXXXXXXXXXXXXXXXX'; // TODO: replace with your actual public key
            if (!PAYSTACK_PUBLIC_KEY || PAYSTACK_PUBLIC_KEY.includes('XXXX')) {
              throw new Error('Invalid Paystack public key configured on frontend');
            }

            showPaymentStatus('Opening Paystack checkout...', 'info');
            await loadPaystackScript();

            const handler = (window as any).PaystackPop.setup({
              key: PAYSTACK_PUBLIC_KEY,
              email: user.email,
              amount: 500 * 100, // Kobo
              currency: 'NGN',
              ref: reference,
              callback: async function(response) {
                try {
                  showPaymentStatus('Verifying payment...', 'info');
                  const verifyRes = await verifyPayment({ reference });
                  if (verifyRes?.data?.success) {
                    showPaymentStatus('Payment successful! Redirecting to dashboard...', 'success');
                    setTimeout(() => { location.href = './dashboard.html'; }, 1500);
                  } else {
                    console.error('verifyPayment returned non-success', verifyRes);
                    showPaymentStatus('Payment could not be verified. Please contact support.', 'error');
                  }
                } catch (err) {
                  console.error('verifyPayment failed', err);
                  showPaymentStatus('Payment verification failed. Please try again.', 'error');
                } finally {
                  payBtn.disabled = false;
                  payBtn.textContent = 'Pay â‚¦500 Now';
                }
              },
              onClose: function() {
                showPaymentStatus('Payment window closed. No charge made.', 'info');
                payBtn.disabled = false;
                payBtn.textContent = 'Pay â‚¦500 Now';
              }
            });
            handler.openIframe();
				
			} catch (error) {
				console.error('Payment error:', error);
				showPaymentStatus('Payment failed: ' + error.message, 'error');
				document.getElementById('pay-btn').disabled = false;
				document.getElementById('pay-btn').textContent = 'Pay â‚¦500 Now';
			}
		};
		
		function showPaymentStatus(message, type) {
			const statusEl = document.getElementById('payment-status');
			statusEl.textContent = message;
			statusEl.className = type;
			statusEl.style.display = 'block';
		}

        function loadPaystackScript() {
          return new Promise((resolve, reject) => {
            if ((window as any).PaystackPop) return resolve(true);
            const script = document.createElement('script');
            script.src = 'https://js.paystack.co/v1/inline.js';
            script.onload = () => resolve(true);
            script.onerror = () => reject(new Error('Failed to load Paystack script'));
            document.body.appendChild(script);
          });
        }
	})();
	</script>
</body>
</html>

